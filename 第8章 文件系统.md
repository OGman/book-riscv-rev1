文件系统的目标是组织和保存数据。文件系统通常支持在用户和应用之间共享数据，以及数据持久化，即在重启之后数据仍然有效。

xv6文件系统提供了类Unix的文件、目录、路径名（见第1章）以及将数据保存在一个虚拟硬盘上的持久化（见第4章）。文件系统主要面临以下几个挑战：

- 文件系统需要硬盘上的数据结构用于代表有名称的目录树和文件，用于记录每个文件内容的块的身份，以及记录硬盘上哪些区域是空闲的。
- 文件系统必须支持crash恢复。就是说，如果crash（例如断电）出现，文件系统必须能够在重启后正确工作。风险在于crash可能会打断一系列的更新并遗留一些非持久的硬盘上的数据结构（例如一个块既在文件中被使用也被标记为空闲）。
- 不同进程可能同时在文件系统进行操作，所以文件系统代码必须加以协调以维持不变性。
- 访问硬盘的速度比访问内存要低几个数量级，所以文件系统必须在内存上维护一个常用块的缓存。

本章其余部分将解释xv6怎样应对这些挑战。

# 8.1 概述

xv6文件系统实现组织为7层，如图8.1所示。硬盘层在virtio硬件驱动上读写块。缓冲区缓存层缓存了硬盘块，并且同步对它们的访问，保证同一时间内只有一个内核进程可以修改保存在任何特定块内的数据。日志层允许更高的层将对几个块的修改打包在一次传输中，保证遇到crash时以原子方式更新这些块（即所有的要么都更新了要么都没更新）。inode层提供了单独的文件，每个文件由一个有着唯一的i-编号，并包含一些持有文件数据的块的inode表示。目录层将每个目录实现为一种特殊的inode，inode的内容是一系列的目录项，每个目录项包含了一个文件的名称和i-number。路径名层提供了层次式的路径名例如/usr/rtm/xv6/fs.c，并且使用递归查找解析它们。文件描述符层使用文件系统接口抽象了很多Unix资源（例如，管道，设备，文件等等），让应用程序员的生活更容易。

文件系统必须有一个计划，在硬盘哪里存放inode和内容块。为了实现这个目标，xv6将硬盘划分为价格部分，如图8.2。文件系统不使用block0（e）


