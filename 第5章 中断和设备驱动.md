驱动，是操作系统中管理特定设备的代码：它注册设备硬件，告诉设备执行操作，处理结果中断，并与可能在等待设备I/O的进程通信。驱动代码可能有很多小花招，因为驱动与它管理的设备协同执行。此外，驱动必须理解设备的硬件接口，这些接口可能很繁琐而且缺乏文档。

需要操作系统关注的设备通常在操作系统中注册，以生成中断，中断是trap的一种。内核trap处理代码识别到设备产生中断后，调用驱动的中断handler；在xv6中，这个分发过程在devintr(kernel/tarp.c:177)中。

很多设备驱动在两种上下文中执行代码：上半段运行在进程的内核线程中，下半段在中断时刻执行。上半段被read，write之类的系统调用所调用，来让设备执行I/O操作。这些代码可能请求硬件开始一项操作（例如，请求硬盘读一个块）；然后等待操作完成。最终设备完成了操作，触发中断。设备的中断handler，扮演下半段角色，指出是什么操作已经完成，然后唤醒相应的等待进程，接着告诉硬件开始为执行下一项等待中的操作。

concurrently

# 5.1 代码：控制台输入

控制台驱动（console.c）是驱动结构的一个简单例子。控制台驱动通过RISC-V附带的UART串口硬件接收人类打印的字符。控制台驱动每次积累一行的输入，处理特殊字符例如backspace和ctrl-u。用户进程，例如shell，使用read系统调用，来抓取控制台的输入行。当你在QEMU中向xv6输入时，你的按键通过QEMU的模拟UART硬件传递到xv6。

跟驱动交互的UART硬件QEMU模拟的一块16550芯片。在真实计算机上，16550能管理连接到终端或其他计算机的RS232串口。当运行QEMU时，它连接到你的键盘和显示器上。


keystrokes

The console driver accumulates a line of input at a time, processing special input characters such as backspace and control-u. 
