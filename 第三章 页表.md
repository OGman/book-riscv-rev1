操作系统通过页表为每一个进程提供了它自己的私有地址空间和内存。页表决定了内存地址表示什么，也决定了哪部分物理地址可以被访问。它们允许xv6将不同进程的地址空间隔离开来，并将他们复用到同一物理内存上。页表提供了一个间接层，让xv6能玩一些小花招：将同一段内存（跳板页）映射到不同的地址空间，使用未映射的页来保护内核和用户栈。本章中其他部分解释了RISC-V硬件所提供的页表，以及xv6如何使用它们。

# 3.1 分页硬件

提醒一下，RISC-V指令（包括用户和内核）使用虚拟地址。而机器的RAM，或物理内存，使用物理地址进行索引。RISC-V页表硬件连接这两种地址，将虚拟地址映射到物理地址。

xv6运行在Sv39 RISC-V上，这表示在64位虚拟地址中，只使用了低39位，而高25位未使用。在这种Sv39配置中，RISC-V页表逻辑上是一个包含2^27（134,217,728）个页表项（PTE，page table entry）的向量表。每个PTE包含一个44位物理页编码（PPN，physical page number）和一些标志位。分页硬件使用39位虚拟地址中的高27位作为索引，在页表中找到对应的PTE，然后用PTE中的44位地址作为高位，虚拟地址中的低12位作为地位，构造出一个56位的物理地址。图3.1展现了这个过程，其中页表按照逻辑理解，被描绘为一个PTE构成的向量表（图3.2给出了真实情况）。页表给予了操作系统控制虚拟地址到物理地址翻译的能力。内存的粒度大小是4096（2^12）的对齐块。这种块叫作页。

在Sv39 RISC-V中，高25位没有参与到地址转换中；未来RISC-V可能会使用这些位定义更多层的地址转换。物理地址也还有增加的空间：PTE格式中的物理页编号仍有增长10位的空间。

如图3.2，实际的地址转换分为三步。页表以三层树的结构保存在物理内存中。树的根是一张4096字节的页表，包含512PTE，每个PTE都包含了下一层页表存放页的物理地址。这些页中包含了512PTE，保存树的最终层。分页硬件使用27位中的高9位查找根页表中的PTE，中9位查找中层页表中的PTE，低9位查找最终PTE。

翻译地址时，如果所需要的三个PTE中有任意一个不存在，分页硬件都会产生一个分页错误异常，让内核去处理这个异常（参见第四章）。这个三层结构让页表无需存放完整的页表，因为大段的虚拟地址没有映射是非常常见的情况。

每个PTE都包含标志位，用来告诉分页硬件，关联的页允许怎样使用。PTE_V表示PTE是否存在：如果没设置它，对这个页的引用会产生异常（即不允许）。PTE_R控制是否允许指令读这个页。PTE_W控制是否允许指令写这个页。PTE_X决定CPU是否能将页中国的内容解释为指令并运行它们。PTE_U控制是否允许用户模式下的指令访问这个页；如果未设置PTE_U，PTE只能在管理者模式下使用。图3.2描绘了它的工作方法。这些标志位和所有其他与分页硬件相关的结构体都定义在（kernel/riscv.h）中。

为了让硬件使用页表，内核必须将根页表页的物理地址写入satp寄存器中。每个CPU都有它自己的satp。CPU会将后续所有指令产生的地址都使用它satp中所存放的页表进行翻译。每个CPU拥有自己的satp寄存器，所以不同的CPU可以运行不同的进程，每个进程都有用它自己的页表描述的私有的地址空间。

一些名词需要解释一下。物理内存指的是DRAM中的存储单元。每一字节的物理内存都有一个地址，叫物理地址。指令只使用虚拟地址，分页硬件将虚拟地址翻译成物理地址，然后发送给DRAM硬件来读取或写入存储。虚拟内存不像物理内存和虚拟地址那样，它不是物理实体。它指的是内核提供的用来管理物理内存和虚拟地址的抽象和机制的集合。



# 3.2 内核地址空间

# 3.3 代码：创建地址空间

# 3.4 物理内存分配

# 3.5 代码：物理内存分配器

# 3.6 进程地址空间

# 3.7 代码：sbrk

# 3.8 代码：exec

# 3.9 真实世界
