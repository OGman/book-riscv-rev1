任何操作系统都有可能运行比CPU数更多的进程，所以需要对如何在进程之间分享CPU时间进行妥善安排。理想的共享应该对用户进程透明。常用的方法是在硬件CPU上复用进程，给每个进程都呈现一种假象，它拥有它自己的虚拟CPU。这一章阐述了xv6怎样实现这样的复用。

likely  illusion

# 7.1 复用

xv6中，有两种情况下，会将CPU从一个进程切换到另一个进程，从而实现复用。第一种，当进程等待设备或管道I/O完成，或等待子进程退出，或者在sleep系统调用中等待时，xv6的sleep与wakeup机制会进行切换。第二种，xv6周期性地强制切换，来处理长时间计算而不进行睡眠的进程。这种复用制造了每个进程有自己CPU的假象，正如xv6使用内存分配器和硬件页表来制造每个进程有自己的内存的假象一样。

实现复用提出了一些挑战。首先，如何从一个进程切换到另一个进程？虽然切换上下文的想法看起来很简单，但它的实现是xv6最为晦涩难懂的代码之意。其次，怎样用一种对用户进程透明的方法来强制切换？xv6使用标准技术，使用计时器中断来驱动上下文切换。第三，很多CPU可能同时在进程间切换，因此有必要制定一个锁方案来避免竞争。第四，进程的内存和其他资源必须在进程退出时释放，但进程无法独立完成所有，（例如）它不能释放自己还在被使用的内核栈。

opaque
